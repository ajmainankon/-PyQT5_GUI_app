import subprocess
import re


def get_name():
	return "Docker Socket Misconfiguration"


def check():
	log = ""
	try:
		cmd = 'docker --version'
		subprocess.check_output(cmd, shell=True)
		#print(output)
		cmd = "grep -c 'tcp://' /lib/systemd/system/docker.service"
		output = int(subprocess.check_output(cmd, shell=True).decode())
		print(output)
		if output >= 1:
			log += "Vulnerable" + "\n"
			return True, log
		else:
			log += "safe" + "\n"
			return False, log
	except Exception as e:
		log += "Docker not installed" + "\n"
		log += str(e)
		return False, log
	
def fix():
	vuln, log = check()
	print(vuln)
	try:
		if vuln:
			print("The Docker Daemon appears to be running through a tcp socket. If you are not aware of the good practices regarding tcp socket configuration, we highly recommend disabling it.")
			#Ask user if they want us to automatically disable tcp socket
			cmd = "sudo sed -i 's/-H tcp:\/\/[0-9]*\.[0-9]*\.[0-9]*\.[0-9]:[0-9]* //g' /lib/systemd/system/docker.service && \
			sudo systemctl daemon-reload &1>null && \
			sudo service docker restart &1>null"
			subprocess.run(cmd, shell=True) # delete tcp socker parameter in configuration file & reload docker
			return True, log
		else:
			return False, log
	except Exception as e:
		log += str(e)
		return False, log

#fix()
